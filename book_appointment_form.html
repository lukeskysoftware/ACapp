<!DOCTYPE html>
<html>
<head>
    <title>Book Appointment</title>
    <?php include 'config.php'; ?>
     <?php include 'menu.php'; ?>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=<?php echo GOOGLE_MAPS_API_KEY; ?>&libraries=places"></script>
</head>
<body>
    <h2>Book Appointment</h2>
    <form id="appointmentForm" action="book_appointment.php" method="post">
        <label for="address">Address:</label><br>
        <input type="text" id="address" name="address" required><br><br>
        
        <div id="zoneDetails" style="display:none;">
            <h3>Available Slots</h3>
            <div id="slots"></div>
        </div>

        <div id="userDetails" style="display:none;">
            <label for="name">Name:</label><br>
            <input type="text" id="name" name="name" required><br><br>
            
            <label for="surname">Surname:</label><br>
            <input type="text" id="surname" name="surname" required><br><br>
            
            <label for="phone">Phone:</label><br>
            <input type="tel" id="phone" name="phone" required><br><br>
            
            <label for="notes">Notes:</label><br>
            <textarea id="notes" name="notes"></textarea><br><br>
            
            <input type="hidden" id="selectedSlot" name="selectedSlot">
            <input type="submit" value="Confirm Appointment">
        </div>
    </form>
    
    <script>
        function initAutocomplete() {
            const input = document.getElementById('address');
            const options = {
                types: ['address'],
                componentRestrictions: { country: 'us' }
            };
            const autocomplete = new google.maps.places.Autocomplete(input, options);
            autocomplete.addListener('place_changed', onPlaceChanged);
        }

        function onPlaceChanged() {
            const place = this.getPlace();
            if (!place.geometry) {
                return;
            }
            fetchZones(place.formatted_address);
        }

        function fetchZones(address) {
            fetch('get_zones.php?address=' + encodeURIComponent(address))
                .then(response => response.json())
                .then(data => {
                    if (data.zones.length > 0) {
                        displaySlots(data.zones);
                    } else {
                        alert('No zones found for this address.');
                    }
                });
        }

        function displaySlots(zones) {
            const slotsDiv = document.getElementById('slots');
            slotsDiv.innerHTML = '';
            zones.forEach(zone => {
                const zoneDiv = document.createElement('div');
                zoneDiv.innerHTML = `<h4>${zone.name}</h4>`;
                zone.slots.forEach(slot => {
                    const slotLink = document.createElement('a');
                    slotLink.href = '#';
                    slotLink.textContent = `${slot.day} ${slot.time}`;
                    slotLink.onclick = () => selectSlot(slot);
                    zoneDiv.appendChild(slotLink);
                    zoneDiv.appendChild(document.createElement('br'));
                });
                slotsDiv.appendChild(zoneDiv);
            });
            document.getElementById('zoneDetails').style.display = 'block';
        }

        function selectSlot(slot) {
            document.getElementById('selectedSlot').value = slot.id;
            document.getElementById('userDetails').style.display = 'block';
        }

        google.maps.event.addDomListener(window, 'load', initAutocomplete);
    </script>
</body>
</html>
